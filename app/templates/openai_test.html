{% extends "base.html" %}

{% block title %}Test OpenAI - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    ü§ñ Test de Connexion OpenAI
                </h1>
                <p class="lead text-muted">
                    V√©rifiez votre configuration OpenAI et testez la g√©n√©ration de plans
                </p>
            </div>

            <!-- Configuration Status Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear-fill me-2"></i>
                        Statut de la Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div id="config-status" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">V√©rification de la configuration...</p>
                    </div>
                </div>
            </div>

            <!-- Connection Test Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-wifi me-2"></i>
                        Test de Connexion
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <button id="test-connection-btn" class="btn btn-success btn-lg px-5 py-3 shadow">
                            <i class="bi bi-play-circle-fill me-2"></i>
                            Tester la Connexion OpenAI
                        </button>
                    </div>
                    
                    <div id="connection-result" class="d-none">
                        <!-- R√©sultat du test affich√© ici -->
                    </div>
                </div>
            </div>

            <!-- Plan Generation Test Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightbulb-fill me-2"></i>
                        Test de G√©n√©ration de Plan
                    </h5>
                </div>
                <div class="card-body">
                    <form id="plan-generation-form">
                        <div class="mb-4">
                            <label for="project-description" class="form-label fw-bold">
                                <i class="bi bi-file-text me-1"></i>
                                Description du Projet de Test
                            </label>
                            <textarea id="project-description" 
                                      class="form-control form-control-lg" 
                                      rows="4" 
                                      placeholder="D√©crivez un projet simple pour tester la g√©n√©ration...">Application web de gestion de t√¢ches avec React et Node.js</textarea>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="tech-stack" class="form-label fw-bold">
                                    <i class="bi bi-stack me-1"></i>
                                    Stack Technologique
                                </label>
                                <input type="text" 
                                       id="tech-stack" 
                                       class="form-control" 
                                       placeholder="React, Node.js, MongoDB"
                                       value="React, Node.js, MongoDB">
                            </div>
                            <div class="col-md-6">
                                <label for="timeline" class="form-label fw-bold">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    Timeline
                                </label>
                                <input type="text" 
                                       id="timeline" 
                                       class="form-control" 
                                       placeholder="3 mois"
                                       value="3 mois">
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-info btn-lg px-5 py-3 shadow">
                                <i class="bi bi-magic me-2"></i>
                                G√©n√©rer un Plan de Test
                            </button>
                        </div>
                    </form>

                    <div id="plan-result" class="d-none mt-4">
                        <!-- R√©sultat de la g√©n√©ration affich√© ici -->
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="text-center">
                <a href="{{ url_for('main.generator') }}" class="btn btn-outline-primary me-3">
                    <i class="bi bi-arrow-left me-1"></i>
                    Retour au G√©n√©rateur
                </a>
                <a href="{{ url_for('main.config') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-gear me-1"></i>
                    Configuration
                </a>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript pour les tests -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chargement du statut de configuration
    loadConfigStatus();
    
    // Test de connexion
    document.getElementById('test-connection-btn').addEventListener('click', testConnection);
    
    // Test de g√©n√©ration de plan
    document.getElementById('plan-generation-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateTestPlan();
    });
});

async function loadConfigStatus() {
    try {
        const response = await fetch('/api/openai/config');
        const result = await response.json();
        
        const statusDiv = document.getElementById('config-status');
        
        if (result.success) {
            const data = result.data;
            statusDiv.innerHTML = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <i class="bi bi-key-fill fs-4 text-primary"></i>
                            <h6 class="mt-2">Cl√© API</h6>
                            <span class="badge ${data.api_key_configured ? 'bg-success' : 'bg-danger'}">
                                ${data.api_key_configured ? 'Configur√©e' : 'Manquante'}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <i class="bi bi-cpu-fill fs-4 text-info"></i>
                            <h6 class="mt-2">Mod√®le</h6>
                            <small class="text-muted">${data.model}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <i class="bi bi-building fs-4 text-warning"></i>
                            <h6 class="mt-2">Organisation</h6>
                            <small class="text-muted">${data.organization || 'Non d√©finie'}</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border rounded p-3">
                            <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                            <h6 class="mt-2">Status</h6>
                            <span class="badge bg-${data.status === 'configured' ? 'success' : 'warning'}">
                                ${data.status}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Erreur de configuration: ${result.error}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('config-status').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill me-2"></i>
                Erreur lors du chargement de la configuration
            </div>
        `;
    }
}

async function testConnection() {
    const btn = document.getElementById('test-connection-btn');
    const resultDiv = document.getElementById('connection-result');
    
    // √âtat de chargement
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Test en cours...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/openai/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        resultDiv.classList.remove('d-none');
        
        if (result.success) {
            const data = result.data;
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle-fill me-2"></i>Connexion R√©ussie !</h6>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <strong>Mod√®le:</strong><br>
                            <code>${data.model}</code>
                        </div>
                        <div class="col-md-4">
                            <strong>R√©ponse:</strong><br>
                            <span class="text-success">"${data.response}"</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Tokens utilis√©s:</strong><br>
                            <small class="text-muted">${data.usage.total_tokens} tokens</small>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="bi bi-x-circle-fill me-2"></i>√âchec de la Connexion</h6>
                    <p><strong>Erreur:</strong> ${result.error}</p>
                    ${result.message ? `<p><strong>Message:</strong> ${result.message}</p>` : ''}
                </div>
            `;
        }
    } catch (error) {
        resultDiv.classList.remove('d-none');
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill me-2"></i>
                Erreur de communication avec le serveur
            </div>
        `;
    } finally {
        btn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Tester √† Nouveau';
        btn.disabled = false;
    }
}

async function generateTestPlan() {
    const btn = document.querySelector('#plan-generation-form button[type="submit"]');
    const resultDiv = document.getElementById('plan-result');
    
    // R√©cup√©ration des donn√©es du formulaire
    const projectDescription = document.getElementById('project-description').value;
    const techStack = document.getElementById('tech-stack').value.split(',').map(s => s.trim());
    const timeline = document.getElementById('timeline').value;
    
    // √âtat de chargement
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>G√©n√©ration en cours...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/openai/generate-plan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                project_description: projectDescription,
                requirements: {
                    technology_stack: techStack,
                    timeline: timeline,
                    team_size: 3,
                    features: ['Interface utilisateur', 'Gestion des donn√©es', 'Authentification']
                }
            })
        });
        
        const result = await response.json();
        
        resultDiv.classList.remove('d-none');
        
        if (result.success) {
            const data = result.data;
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle-fill me-2"></i>Plan G√©n√©r√© avec Succ√®s !</h6>
                    <div class="mt-3">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Mod√®le utilis√©:</strong> ${data.metadata.model}
                            </div>
                            <div class="col-md-6">
                                <strong>Tokens utilis√©s:</strong> ${data.metadata.tokens_used}
                            </div>
                        </div>
                        <div class="border rounded p-3 bg-light">
                            <h6>Plan de D√©veloppement G√©n√©r√©:</h6>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <pre class="text-wrap">${data.plan}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="bi bi-x-circle-fill me-2"></i>√âchec de la G√©n√©ration</h6>
                    <p><strong>Erreur:</strong> ${result.error}</p>
                    ${result.validation_errors ? `
                        <div class="mt-2">
                            <strong>Erreurs de validation:</strong>
                            <ul class="mb-0">
                                ${result.validation_errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    } catch (error) {
        resultDiv.classList.remove('d-none');
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle-fill me-2"></i>
                Erreur de communication avec le serveur
            </div>
        `;
    } finally {
        btn.innerHTML = '<i class="bi bi-magic me-2"></i>G√©n√©rer √† Nouveau';
        btn.disabled = false;
    }
}
</script>
{% endblock %} 